<!doctype html>
<html>
<title>Flaskr</title>
<link rel=stylesheet type=text/css href="style.css">
<script src="js/jquery.js"></script>
<script src="js/mustache.js"></script>
<script src="js/class.js"></script>
<script src="js/mine.js"></script>

<script>

EntryManager = BaseManager.extend({

    init: function(){
        this._super("http://127.0.0.1:5000/api/1.0/entries/");
    }
    
});
    
EntryView = Class.extend({

    template_container: "http://127.0.0.1:5000/static/site/templates/",

    init: function(objects){
        view = this; // prevenindo conflitos
        view.objects = objects; // manager
    },

    render_template: function(template_name, data) {        
        template_name = view.template_container + template_name + ".mustache";
        return render_template(template_name, data);
    },

    get_index: function(){

        var entries = view.objects.get();
        $("#content").html(view.render_template("entries", entries));

        $("form#add_entry").submit(function(event){
            event.preventDefault();
            view.post(form_to_dict(this));
            return true;
        });

    },

    get: function(args){

        if(utype(args) || utype(args.id) || args.id === null){
            return view.get_index();
        }

        id = args.id;

        entry = view.objects.get(id);
        $("#content").html(view.render_template("entry", entry));

        $("button#edit_entry").click(function(){
            view.get_edit_form({id: id}); // ou view.put("get", id)
        });

        $("button#delete_entry").click(function(){
            view.delete({id: id});
        });

    },

    post: function(args) {
        view.objects.post(args);
        view.get();
    },

    get_edit_form: function(args){

        id = args.id;

        entry = view.objects.get(id);
        $("#content").html(view.render_template("edit_entry", entry));

        $("form#edit_entry").submit(function(event){
            event.preventDefault();
            view.put({method: "put", id: id, data: form_to_dict(this)});
            return true;
        });

    },

    put: function(args){

        method = args.method;
        id = args.id;
        data = args.data;

        if(method == "get") {            
            view.get_edit_form({id: id});            
        } else if (method == "put") {
            result = view.objects.put(id, data);
            console.log("Entry " + id + " atualizado com sucesso. RESULT: " + result.result);
            view.get();
        }

    },

    delete: function(args) {
        id = args.id;
        result = view.objects.delete(id);
        console.log("Entry " + id + " deletado com sucesso. RESULT: " + result.result);
        view.get();
    },

    /**
     * Factory method para requisitar view actions
     * @args Deve ser do tipo {}. Opcional
     * @args.action Nome de um action especifico a ser solicitado. Default = get
    **/
    action: function(args){

        var action_name = args.action;

        if (utype(action_name)) {
            action_name = "get";
        } else if (action_name != "get"){
            action_name = "get_" + action_name;
        }

        result = view[action_name](args); // chamando metodo publico (get) da view (action) de forma reflexiva
        return result;
    }

});

$( document ).ready(function() {

    entryObjects = new EntryManager(); // ou new BaseManager("http://127.0.0.1:5000/api/1.0/entries/")
    entryView = new EntryView(entryObjects);
    entryView.action(getParameters()); // requisitando view action conforme parametros da url

    console.log( "document loaded" );
});

</script>

<body>
    
    <div class=page>
        
        <h1>Flaskr</h1>

        <div id="content">
        </div>
    </div>

</body>
</html>