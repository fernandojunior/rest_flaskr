<!doctype html>
<html>
<title>Flaskr</title>
<link rel=stylesheet type=text/css href="style.css">
<script src="js/jquery.js"></script>
<script src="js/mustache.js"></script>
<script src="js/class.js"></script>
<script src="js/mine.js"></script>

<script>

var EntryViews = {
    
    manager: new AsyncBaseManager({api_url: "http://127.0.0.1:5000/api/1.0/entries/", async: true}),

    index: BaseView.extend({

        api: "get",

        callback: function(response){
            $("#content").html(template.render("http://127.0.0.1:5000/static/site/templates/entries.mustache", response));

            $("form#add_entry").submit(function(e){
                e.preventDefault();
                view.run_from(EntryViews, "post", {data: form_to_dict(e.target)});
                return true;
            });
        }

    }),

    get: BaseView.extend({
        api: "get",

        init: function(args) {
            this.data = {id: args.id};
        },

        before: function(){

            if (typeof(this.data.id ) === "undefined"){
                view.run_from(EntryViews, "index");
                return false;
            }

            return true;
        },

        callback: function(response){

            $("#content").html(template.render("http://127.0.0.1:5000/static/site/templates/entry.mustache", response));

            $("button#edit_entry").click(function(){
                view.run_from(EntryViews, "get_edit_form", {id: response.entry.id});
            });

            $("button#delete_entry").click(function(){
                view.run_from(EntryViews, "delete", {id: response.entry.id});
            });
        }

    }),

    post: BaseView.extend({        
        api: "post",
        
        init: function(args){
            this.data = {data: args.data};
        },
        
        callback: function(response){
            console.log(JSON.stringify(response));
            view.run_from(EntryViews, "index");
        }
    }),
    
    get_edit_form: BaseView.extend({
        api: "get",
        
        init: function(args){
            this.data = {id: args.id};
        },
        
        callback: function(response){

            $("#content").html(template.render("http://127.0.0.1:5000/static/site/templates/edit_entry.mustache", response));

            $("form#edit_entry").submit(function(e){
                e.preventDefault();                
                view.run_from(EntryViews, "put", {id: response.entry.id, data: form_to_dict(e.target)});                
                return true;
            });
        }    
    }),
    
    put: BaseView.extend({
        api: "put",
        
        init: function(args){
            this.data = {id: args.id, data: args.data};
        },
        
        callback: function(response){
            console.log("Entry atualizado com sucesso. RESULT: " + response.result);
            view.run_from(EntryViews, "index");
        }
    }),

    delete: BaseView.extend({
        api: "delete",
    
        init: function(args){
            this.data = {id: args.id};
        },

        callback: function(response){
            console.log("Entry deletado com sucesso. RESULT: " + response.result);
            view.run_from(EntryViews, "index");
        }

    })
}

$( document ).ready(function() {
    
    var view_name = "get";
    
    if (getParameter("view_name") != null){
        view_name = getParameter("view_name");
    }
    
    view.run_from(EntryViews, view_name, getParameters());

    console.log( "document loaded" );
});

</script>

<body>
    
    <div class=page>
        
        <h1>Flaskr</h1>

        <div id="content">
        </div>
    </div>

</body>
</html>