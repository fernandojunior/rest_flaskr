<!doctype html>
<html>
<title>Flaskr</title>
<link rel=stylesheet type=text/css href="style.css">
<script src="js/jquery.js"></script>
<script src="js/mustache.js"></script>
<script src="js/class.js"></script>
<script src="js/mine.js"></script>

<script>

EntryManager = AsyncBaseManager.extend({

    init: function(){
        this._super({api_url: "http://127.0.0.1:5000/api/1.0/entries/", async: true});
    }

});

EntryViews = Class.extend({

    template_container: "http://127.0.0.1:5000/static/site/templates/",

    init: function(api){
        this.api = api; // api manager
        self = this;
    },

    render: function(template_name, data) {
        return template.render(self.template_container + template_name + ".mustache", data);
    },
    
    get_index: function(){
        
        var callback = function(response){

            var content = self.render("entries", response);

            $("#content").html(content);

            $("form#add_entry").submit(function(e){
                e.preventDefault();
                self.post({data: form_to_dict(e.target)});
                return true;
            });
        };

        self.api.get({}, callback);

    },

    get: function(args){
        var id = args.id;

        if(utype(args) || utype(id) || id === null){
            return self.get_index();
        }

        var callback = function(response){

            $("#content").html(self.render("entry", response));

            $("button#edit_entry").click(function(){
                self.get_edit_form({id: id});
            });

            $("button#delete_entry").click(function(){
                self.delete({id: id});
            });

        };

        self.api.get({id: id}, callback);

    },

    post: function(args) {
        var data = args.data;

        self.api.post({data: data});
        self.get_index();
    },

    get_edit_form: function(args){
        var id = args.id;

        var callback = function(response){

            $("#content").html(self.render("edit_entry", response));

            $("form#edit_entry").submit(function(e){
                e.preventDefault();

                self.put({
                    id: id,
                    data: form_to_dict(e.target)
                });                
                return true;
            });
        }
        
        self.api.get({id: id}, callback);

    },

    put: function(args){
        var id = args.id;
        var data = args.data;

        var callback = function(response){
            console.log("Entry " + id + " atualizado com sucesso. RESULT: " + response.result);
            self.get_index();   
        }

        self.api.put({id: id, data: data}, callback);

    },

    delete: function(args) {
        var id = args.id;

        var callback = function(response){
            console.log("Entry " + id + " deletado com sucesso. RESULT: " + response.result);
            self.get_index();
        }

        self.api.delete({id: id}, callback);
    },

    /**
     * Factory method para requisitar view actions
     * @args Deve ser do tipo {}. Opcional
     * @args.action Nome de um action especifico a ser solicitado. Default = get
    **/
    action: function(args){
        var action = args.action;

        if (utype(action)) {
            action = "get";
        } else if (action != "get"){
            action = "get_" + action;
        }

        return self[action](args); // chamando metodo publico (get) da view (action) de forma reflexiva
    }

});

$( document ).ready(function() {

    api = new EntryManager(); // entry objects manager
    views = new EntryViews(api); // entry views 
    views.action(getParameters()); // requisitando view action conforme parametros da url

    console.log( "document loaded" );
});

</script>

<body>
    
    <div class=page>
        
        <h1>Flaskr</h1>

        <div id="content">
        </div>
    </div>

</body>
</html>