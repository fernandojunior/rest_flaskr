<!doctype html>
<html>
<title>Flaskr</title>
<link rel=stylesheet type=text/css href="style.css">
<script src="js/jquery.js"></script>
<script src="js/mustache.js"></script>
<script src="js/class.js"></script>
<script src="js/mine.js"></script>

<script>

EntryManager = BaseManager.extend({

    init: function(){
        this._super("http://127.0.0.1:5000/api/1.0/entries/");
    }
    
});

EntryView = Class.extend({
    
    template_path: "http://127.0.0.1:5000/static/site/templates/",

    init: function(objects){
        view = this; // prevenindo conflitos
        view.objects = objects;
    },

    render_template: function(template_name, data) {        
        template_name = view.template_path + template_name + ".mustache";        
        return render_template(template_name, data);
    },

    get: function(id){
        if (typeof(id) === "undefined" || id == null) {

            var entries = view.objects.get();
            $( "#content" ).html(view.render_template("entries", entries));

            $("form#add_entry").submit(function(event){
                event.preventDefault();
                view.post(form_to_dict(this));
                return true;
            });

        } else {

            entry = view.objects.get(id);
            $("#content").html(view.render_template("entry", entry));

            $("button#edit_entry").click(function(){
                view.put("get", id);
            });

        }
    },

    post: function(data) {
        view.objects.post(data);
        view.get();
    },

    put: function(method, id, data){

        if(method == "get") {

            entry = view.objects.get(id);
            $("#content").html(view.render_template("edit_entry", entry));

            $("form#edit_entry").submit(function(event){
                event.preventDefault();
                view.put("put", id, form_to_dict(this)); // redirect recursivo com o method "put"
                return true;
            });

        } else if (method == "put") {
            result = view.objects.put(id, data);
            console.log("entry " + id + " atualizado com sucesso. RESULT: " + result.result);
            view.get();
        }

    },

    delete: function(id) {    
        result = view.objects.delete(id);    
        console.log("entry " + id + " deletado com sucesso. RESULT: " + result.result);
        view.get();
    }

});


$( document ).ready(function() {

    entryObjects = new EntryManager(); // ou new BaseManager("http://127.0.0.1:5000/api/1.0/entries/")
    entryView = new EntryView(entryObjects);

    if(getParameter("id") != null){
        entryView.get(getParameter("id"));
    } else {
        entryView.get();
    }

    console.log( "document loaded" );
});

</script>

<body>
    
    <input type="button" value="delete entry" onclick="deleteEntry()">
    
    <div class=page>
        
        <h1>Flaskr</h1>

        <div id="content">
        </div>
    </div>

</body>
</html>