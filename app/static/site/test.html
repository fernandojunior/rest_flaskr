<!doctype html>
<html>
<title>Flaskr</title>
<link rel=stylesheet type=text/css href="../style.css">
<script src="../jquery.js"></script>
<script src="../mustache.js"></script>
    

<script>

var BASE_URL = "http://127.0.0.1:5000/api/1.0";
var TEMPLATE_URL = "http://127.0.0.1:5000/static/site/templates/";
    

/**
 * Retorna o valor de um parametro da url
 * @param name Nome do parametro
 * @ref http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
**/
function getParameter(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? null : decodeURIComponent(results[1].replace(/\+/g, " "));
}

/**
 * Funcao que retorna um template .mustache
 * @param template_name Nome do template (obs. sem a extensao .mustache)
**/
function get_template(template_name){
    
    var url = TEMPLATE_URL + template_name + ".mustache";
    
    var template = "";
    
    $.ajax({
        url: url,
        type: 'GET',
        async: false,
        success: function(data) {
            template = data;
        }
    });
    
    Mustache.parse(template);

    return template;
}

/**
 * Renderiza um template com os dados (em json) fornecidos
 * @param template_name Nome do template
 * @param data Dados a serem renderizados no template
**/
function render_template(template_name, data){
    var template = get_template(template_name);    
    return Mustache.render(template, data);
}

/**
 * Serializa os dados de um formulario em um dicionario
 * @param form O formulario a ser serializado (como elemento jQuery)
**/
function form_to_dict(form){

    var array = jQuery(form).serializeArray();

    var dict = {};

    jQuery.each(array, function() {
        dict[this.name] = this.value || '';
    });

    return dict;
}

/**
 * Auxilia a fazer requisicoes assincronas
 * @param uri Recurso da requisicao
 * @param method Metodo HTTP da requisicao
 * @param data Dados a serem anexados na requisicao (que seram transformados em json)
**/
function ajax(uri, method, data){
    
    var request = {
        url: uri,
        type: method,
        contentType: "application/json",
        accepts: "application/json",
        cache: false,
        dataType: 'json',
        data: JSON.stringify(data),

        error: function(jqXHR) {
            console.log("ajax error " + jqXHR.status);
        }
    
    };
    
    return $.ajax(request);

}
    
function getEntry(id){
    
    var uri = BASE_URL + '/entries/' + id;
    
    ajax(uri, "get")
        .done(function(data) {
            $("#content").html(render_template("entry", data));
        });
}

function getEntries(){
    
    var uri = BASE_URL + '/entries/';

    ajax(uri, "get")
        .done(function(data){
            $( "#content" ).html(render_template("entries", data));
            
            $("form#add_entry").submit(function(event){
                event.preventDefault();        
                postEntry(form_to_dict(this));        
                return true;
            });

        });
}

function postEntry(dic){
    
    var uri = BASE_URL + '/entries/';
    
    ajax(uri, "post", dic)
        .done(function(data){
            //$( "#content" ).html("Entry salvo com id " + data.result);
            getEntries();
        });
}
    
function putEntry(dic){
    
    var uri = BASE_URL + '/entries/3';
    
    ajax(uri, "put", dic)
        .done(function(data){
            $( "#content" ).html("atualizando um entry: " + data.result);
        });
}
    
function deleteEntry(){
    
    var uri = BASE_URL + '/entries/2';
    
    ajax(uri, "delete")
        .done(function(data){
            $( "#content" ).html("deletando um entry: " + data.result);
        });
}
    
$( document ).ready(function() {

    if(getParameter("id") != null){
        getEntry(getParameter("id"));
    } else {
        getEntries();
    }

    console.log( "document loaded" );
});
    

</script>

<body>
    
    <input type="button" value="put entry" onclick="putEntry()">
    <input type="button" value="delete entry" onclick="deleteEntry()">
    
    <div class=page>
        
        <h1>Flaskr</h1>

        <div id="content">
        </div>
    </div>

</body>
</html>