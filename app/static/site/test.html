<!doctype html>
<html>
<title>Flaskr</title>
<link rel=stylesheet type=text/css href="../style.css">
<script src="../jquery.js"></script>
<script src="../mustache.js"></script>
<script src="../class.js"></script>
<script src="../mine.js"></script>

<script>

var BASE_URL = "http://127.0.0.1:5000/api/1.0";
var TEMPLATE_URL = "http://127.0.0.1:5000/static/site/templates/";
    
EntryManager = Class.extend({

    root_path: "http://127.0.0.1:5000/api/1.0/entries/",
    
    get: function(id){

        var result;

        if (typeof(id) === "undefined" || id == null) {

            ajax({url: this.root_path, type: "get", async: false})
                .done(function(data) {
                    result = data;
                });

        } else {

            ajax({url: this.root_path + id, type: "get", async: false})
                .done(function(data) {
                    result = data;
                });

        }
        
        return result;

    },

    post: function(data) {
        
        var result;
        
        ajax({url: this.root_path, type: "post", data: data, async: false})
            .done(function(data){
                result = data;
            });
        
        return result;
    },

    put: function(id, data) {
        
        var result;
        
        ajax({url: this.root_path + id, type: "put", data: data, async: false})
            .done(function(data){
                result = data;
            });
        
        return result;
    },

    delete: function(id) {

        var result;

        ajax({url: this.root_path + id, type: "delete", async: false})
            .done(function(data){
                result = data;
            });

        return result;
    }
    
})

entryManager = new EntryManager();

// Views
    
function getEntry(id){

    entry = entryManager.get(id);
    
    $("#content").html(render_template(TEMPLATE_URL + "entry.mustache", entry));
    
    $("button#edit_entry").click(function(){
        putEntry("get", id);
    });

}

function getEntries(){

    var entries = entryManager.get();

    $( "#content" ).html(render_template(TEMPLATE_URL + "entries.mustache", entries));

    $("form#add_entry").submit(function(event){
        event.preventDefault();
        postEntry(form_to_dict(this));
        return true;
    });
}

function postEntry(dic){
    
    entryManager.post(dic);
    
    getEntries(); // redirect
}
    
function putEntry(method, id, dic) {

    if(method == "get") {

        entry = entryManager.get(id);

        $("#content").html(render_template(TEMPLATE_URL + "edit_entry.mustache", entry));

        $("form#edit_entry").submit(function(event){
            event.preventDefault();
            putEntry("put", id, form_to_dict(this));
            return true;
        });

    } else if (method == "put") {
        
        result = entryManager.put(id, dic);
        
        console.log("entry " + id + " atualizado com sucesso. RESULT: " + result.result);
        
        getEntries(); // redirect
    }

}

function deleteEntry(id){

    result = entryManager.delete(id);
    
    console.log("entry " + id + " deletado com sucesso. RESULT: " + result.result);
    
    getEntries(); // redirect

}
    
$( document ).ready(function() {

    if(getParameter("id") != null){
        getEntry(getParameter("id"));
    } else {
        getEntries();
    }

    console.log( "document loaded" );
});

</script>

<body>
    
    <input type="button" value="delete entry" onclick="deleteEntry()">
    
    <div class=page>
        
        <h1>Flaskr</h1>

        <div id="content">
        </div>
    </div>

</body>
</html>